# 벡터 검색 원리 상세 설명

## 🎯 핵심 개념

**벡터 검색**은 텍스트를 **숫자 배열(벡터)**로 바꾸고, **숫자들 간의 거리**를 계산해서 비슷한 것을 찾는 방식입니다.

---

## 1. 기존 키워드 검색 vs 벡터 검색

### 키워드 검색 (기존)
```
검색어: "따뜻한 겨울 옷"
         ↓
      문자열 비교
         ↓
title에 "따뜻한" OR "겨울" OR "옷" 포함된 상품만 검색
```

**한계:** "패딩", "다운자켓"은 검색 안됨 (단어가 다르니까)

---

### 벡터 검색 (새로운 방식)
```
검색어: "따뜻한 겨울 옷"
         ↓
    AI가 벡터로 변환
         ↓
   [0.23, -0.45, 0.67, ...]  (384개 숫자)
         ↓
    모든 상품 벡터와 거리 계산
         ↓
    거리가 가까운 상품 = 의미가 비슷한 상품
```

**장점:** "패딩", "다운자켓", "푸퍼" 등 **단어가 달라도** 의미가 비슷하면 검색됨!

---

## 2. 임베딩(Embedding)이란?

### 텍스트 → 숫자 변환

AI 모델이 텍스트를 **384개의 숫자 배열**로 바꿉니다.

```python
"패딩"  →  [0.12, -0.34, 0.56, 0.78, ...]  # 384개 숫자
"다운자켓" →  [0.11, -0.32, 0.58, 0.75, ...]  # 384개 숫자
"티셔츠"  →  [-0.45, 0.23, -0.12, 0.34, ...]  # 384개 숫자
```

### 왜 이렇게 변환할까?

AI 모델은 **수십억 개의 문장**을 학습해서:
- 비슷한 의미의 단어 → **비슷한 숫자**로 변환
- 다른 의미의 단어 → **다른 숫자**로 변환

```
"패딩" 벡터   ≈  "다운자켓" 벡터   (숫자가 비슷함!)
"패딩" 벡터   ≠  "티셔츠" 벡터    (숫자가 다름)
```

---

## 3. 코사인 유사도 (Cosine Similarity)

두 벡터가 얼마나 비슷한지 측정하는 방법입니다.

### 시각적 이해

```
        ↑
        |     * 패딩 [0.8, 0.6]
        |    /
        |   /  θ (각도 작음 = 유사함)
        |  /
        | / * 다운자켓 [0.75, 0.65]
        |/
        +----------------→
        
        ↑
        |     
        |    * 패딩 [0.8, 0.6]
        |   
        | θ (각도 큼 = 다름)
        |
        +------* 티셔츠 [-0.3, 0.9]
```

### 계산 공식

```
코사인 유사도 = (벡터A · 벡터B) / (|A| × |B|)

결과:
- 1.0 = 완전히 같음
- 0.0 = 관련 없음
- -1.0 = 정반대
```

### 실제 예시

```python
"패딩" ↔ "패딩"     = 1.00  (본인)
"패딩" ↔ "다운자켓"  = 0.68  (매우 유사!)
"패딩" ↔ "티셔츠"   = 0.15  (관련 없음)
```

---

## 4. 전체 흐름도

```
┌─────────────────────────────────────────────────────────────┐
│                    [1] 데이터 준비 단계                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   상품 데이터                    AI 모델                      │
│   ┌──────────┐                ┌──────────┐                 │
│   │ 패딩 자켓  │ ──────────────→│ Sentence │                 │
│   │ 다운점퍼  │                │Transformer│                 │
│   │ 푸퍼 코트  │                └──────────┘                 │
│   └──────────┘                      │                       │
│                                     ↓                       │
│                             ┌──────────────┐                │
│                             │ 벡터 변환     │                │
│                             │ [0.1, 0.3...] │                │
│                             └──────────────┘                │
│                                     │                       │
│                                     ↓                       │
│                             ┌──────────────┐                │
│                             │ OpenSearch   │                │
│                             │ k-NN 인덱스   │                │
│                             └──────────────┘                │
└─────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────┐
│                    [2] 검색 단계                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   사용자 검색어                                              │
│   ┌──────────────┐                                         │
│   │ "겨울 아우터" │                                          │
│   └──────────────┘                                         │
│          │                                                  │
│          ↓                                                  │
│   ┌──────────────┐     ┌──────────────────────────┐        │
│   │ 벡터 변환     │────→│ 검색 벡터: [0.2, 0.5...] │        │
│   └──────────────┘     └──────────────────────────┘        │
│                               │                             │
│                               ↓                             │
│                    ┌─────────────────────┐                  │
│                    │ k-NN 유사도 검색     │                  │
│                    │ (코사인 거리 계산)    │                  │
│                    └─────────────────────┘                  │
│                               │                             │
│                               ↓                             │
│   ┌─────────────────────────────────────────────┐          │
│   │ 결과: 유사도 순 정렬                          │          │
│   │ 1. 패딩 자켓 (유사도: 0.92)                  │          │
│   │ 2. 다운점퍼 (유사도: 0.88)                   │          │
│   │ 3. 푸퍼 코트 (유사도: 0.85)                  │          │
│   └─────────────────────────────────────────────┘          │
└─────────────────────────────────────────────────────────────┘
```

---

## 5. 코드로 이해하기

### Step 1: 상품 임베딩 생성 (1회)

```python
from sentence_transformers import SentenceTransformer

# 1. AI 모델 로드
model = SentenceTransformer('paraphrase-multilingual-MiniLM-L12-v2')

# 2. 상품 title을 벡터로 변환
products = ["패딩 자켓", "다운점퍼", "푸퍼 코트", "티셔츠"]
vectors = model.encode(products)

# 3. 결과
print(vectors[0])  # [0.12, -0.34, 0.56, ...] (384개 숫자)
```

### Step 2: OpenSearch에 저장

```python
# 각 상품에 벡터 필드 추가
product_doc = {
    "title": "패딩 자켓",
    "price": 50000,
    "title_vector": [0.12, -0.34, 0.56, ...]  # 384개 숫자
}

# OpenSearch에 저장
client.index(index="musinsa_products", body=product_doc)
```

### Step 3: 벡터 검색 실행

```python
# 1. 검색어를 벡터로 변환
query = "겨울 아우터"
query_vector = model.encode(query)

# 2. k-NN 검색 (가장 가까운 20개 찾기)
search_query = {
    "query": {
        "knn": {
            "title_vector": {
                "vector": query_vector.tolist(),
                "k": 20  # 상위 20개
            }
        }
    }
}

# 3. 검색 실행
results = client.search(body=search_query, index="musinsa_products")
```

---

## 6. 왜 "패딩"이 "다운자켓"과 비슷한 벡터일까?

AI 모델은 **엄청난 양의 텍스트 데이터**로 학습했습니다:

```
학습 데이터 예시:
- "이번 겨울에는 따뜻한 패딩을 입어야지"
- "다운자켓이 가볍고 따뜻해서 좋아"
- "푸퍼 점퍼가 요즘 유행이야"
- "패딩이랑 다운자켓 뭐가 다르지?"
```

이런 문장들에서 AI가 학습한 것:
- "패딩", "다운자켓", "푸퍼" → **비슷한 문맥**에서 사용됨
- 따라서 → **비슷한 벡터**로 변환됨

---

## 7. 핵심 요약

| 단계 | 설명 |
|------|------|
| **1. 임베딩** | 텍스트를 384개 숫자 배열로 변환 |
| **2. 저장** | 상품별 벡터를 OpenSearch에 저장 |
| **3. 검색** | 검색어도 벡터로 변환 |
| **4. 비교** | 코사인 유사도로 거리 계산 |
| **5. 정렬** | 거리 가까운 순으로 결과 반환 |

### 한 줄 요약

> **"텍스트를 숫자로 바꾸고, 숫자가 비슷한 걸 찾는다!"**

---

## 8. 참고: 사용 중인 모델 정보

```
모델명: paraphrase-multilingual-MiniLM-L12-v2
제작: Microsoft
학습: 50개 언어, 수십억 문장
출력: 384차원 벡터
특징: 한국어 지원, 무료, 빠름
```
